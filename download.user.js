// ==UserScript==
// @name         Youtube Download button
// @version      5.1.4
// @author       L0laapk3
// @match        *://www.youtube.com/*
// @match        *://www.google.com/search*
// @match        *://www.google.ad/search*
// @match        *://www.google.ae/search*
// @match        *://www.google.com.af/search*
// @match        *://www.google.com.ag/search*
// @match        *://www.google.com.ai/search*
// @match        *://www.google.al/search*
// @match        *://www.google.am/search*
// @match        *://www.google.co.ao/search*
// @match        *://www.google.com.ar/search*
// @match        *://www.google.as/search*
// @match        *://www.google.at/search*
// @match        *://www.google.com.au/search*
// @match        *://www.google.az/search*
// @match        *://www.google.ba/search*
// @match        *://www.google.com.bd/search*
// @match        *://www.google.be/search*
// @match        *://www.google.bf/search*
// @match        *://www.google.bg/search*
// @match        *://www.google.com.bh/search*
// @match        *://www.google.bi/search*
// @match        *://www.google.bj/search*
// @match        *://www.google.com.bn/search*
// @match        *://www.google.com.bo/search*
// @match        *://www.google.com.br/search*
// @match        *://www.google.bs/search*
// @match        *://www.google.bt/search*
// @match        *://www.google.co.bw/search*
// @match        *://www.google.by/search*
// @match        *://www.google.com.bz/search*
// @match        *://www.google.ca/search*
// @match        *://www.google.cd/search*
// @match        *://www.google.cf/search*
// @match        *://www.google.cg/search*
// @match        *://www.google.ch/search*
// @match        *://www.google.ci/search*
// @match        *://www.google.co.ck/search*
// @match        *://www.google.cl/search*
// @match        *://www.google.cm/search*
// @match        *://www.google.cn/search*
// @match        *://www.google.com.co/search*
// @match        *://www.google.co.cr/search*
// @match        *://www.google.com.cu/search*
// @match        *://www.google.cv/search*
// @match        *://www.google.com.cy/search*
// @match        *://www.google.cz/search*
// @match        *://www.google.de/search*
// @match        *://www.google.dj/search*
// @match        *://www.google.dk/search*
// @match        *://www.google.dm/search*
// @match        *://www.google.com.do/search*
// @match        *://www.google.dz/search*
// @match        *://www.google.com.ec/search*
// @match        *://www.google.ee/search*
// @match        *://www.google.com.eg/search*
// @match        *://www.google.es/search*
// @match        *://www.google.com.et/search*
// @match        *://www.google.fi/search*
// @match        *://www.google.com.fj/search*
// @match        *://www.google.fm/search*
// @match        *://www.google.fr/search*
// @match        *://www.google.ga/search*
// @match        *://www.google.ge/search*
// @match        *://www.google.gg/search*
// @match        *://www.google.com.gh/search*
// @match        *://www.google.com.gi/search*
// @match        *://www.google.gl/search*
// @match        *://www.google.gm/search*
// @match        *://www.google.gp/search*
// @match        *://www.google.gr/search*
// @match        *://www.google.com.gt/search*
// @match        *://www.google.gy/search*
// @match        *://www.google.com.hk/search*
// @match        *://www.google.hn/search*
// @match        *://www.google.hr/search*
// @match        *://www.google.ht/search*
// @match        *://www.google.hu/search*
// @match        *://www.google.co.id/search*
// @match        *://www.google.ie/search*
// @match        *://www.google.co.il/search*
// @match        *://www.google.im/search*
// @match        *://www.google.co.in/search*
// @match        *://www.google.iq/search*
// @match        *://www.google.is/search*
// @match        *://www.google.it/search*
// @match        *://www.google.je/search*
// @match        *://www.google.com.jm/search*
// @match        *://www.google.jo/search*
// @match        *://www.google.co.jp/search*
// @match        *://www.google.co.ke/search*
// @match        *://www.google.com.kh/search*
// @match        *://www.google.ki/search*
// @match        *://www.google.kg/search*
// @match        *://www.google.co.kr/search*
// @match        *://www.google.com.kw/search*
// @match        *://www.google.kz/search*
// @match        *://www.google.la/search*
// @match        *://www.google.com.lb/search*
// @match        *://www.google.li/search*
// @match        *://www.google.lk/search*
// @match        *://www.google.co.ls/search*
// @match        *://www.google.lt/search*
// @match        *://www.google.lu/search*
// @match        *://www.google.lv/search*
// @match        *://www.google.com.ly/search*
// @match        *://www.google.co.ma/search*
// @match        *://www.google.md/search*
// @match        *://www.google.me/search*
// @match        *://www.google.mg/search*
// @match        *://www.google.mk/search*
// @match        *://www.google.ml/search*
// @match        *://www.google.com.mm/search*
// @match        *://www.google.mn/search*
// @match        *://www.google.ms/search*
// @match        *://www.google.com.mt/search*
// @match        *://www.google.mu/search*
// @match        *://www.google.mv/search*
// @match        *://www.google.mw/search*
// @match        *://www.google.com.mx/search*
// @match        *://www.google.com.my/search*
// @match        *://www.google.co.mz/search*
// @match        *://www.google.com.na/search*
// @match        *://www.google.com.nf/search*
// @match        *://www.google.com.ng/search*
// @match        *://www.google.com.ni/search*
// @match        *://www.google.ne/search*
// @match        *://www.google.nl/search*
// @match        *://www.google.no/search*
// @match        *://www.google.com.np/search*
// @match        *://www.google.nr/search*
// @match        *://www.google.nu/search*
// @match        *://www.google.co.nz/search*
// @match        *://www.google.com.om/search*
// @match        *://www.google.com.pa/search*
// @match        *://www.google.com.pe/search*
// @match        *://www.google.com.pg/search*
// @match        *://www.google.com.ph/search*
// @match        *://www.google.com.pk/search*
// @match        *://www.google.pl/search*
// @match        *://www.google.pn/search*
// @match        *://www.google.com.pr/search*
// @match        *://www.google.ps/search*
// @match        *://www.google.pt/search*
// @match        *://www.google.com.py/search*
// @match        *://www.google.com.qa/search*
// @match        *://www.google.ro/search*
// @match        *://www.google.ru/search*
// @match        *://www.google.rw/search*
// @match        *://www.google.com.sa/search*
// @match        *://www.google.com.sb/search*
// @match        *://www.google.sc/search*
// @match        *://www.google.se/search*
// @match        *://www.google.com.sg/search*
// @match        *://www.google.sh/search*
// @match        *://www.google.si/search*
// @match        *://www.google.sk/search*
// @match        *://www.google.com.sl/search*
// @match        *://www.google.sn/search*
// @match        *://www.google.so/search*
// @match        *://www.google.sm/search*
// @match        *://www.google.sr/search*
// @match        *://www.google.st/search*
// @match        *://www.google.com.sv/search*
// @match        *://www.google.td/search*
// @match        *://www.google.tg/search*
// @match        *://www.google.co.th/search*
// @match        *://www.google.com.tj/search*
// @match        *://www.google.tk/search*
// @match        *://www.google.tl/search*
// @match        *://www.google.tm/search*
// @match        *://www.google.tn/search*
// @match        *://www.google.to/search*
// @match        *://www.google.com.tr/search*
// @match        *://www.google.tt/search*
// @match        *://www.google.com.tw/search*
// @match        *://www.google.co.tz/search*
// @match        *://www.google.com.ua/search*
// @match        *://www.google.co.ug/search*
// @match        *://www.google.co.uk/search*
// @match        *://www.google.com.uy/search*
// @match        *://www.google.co.uz/search*
// @match        *://www.google.com.vc/search*
// @match        *://www.google.co.ve/search*
// @match        *://www.google.vg/search*
// @match        *://www.google.co.vi/search*
// @match        *://www.google.com.vn/search*
// @match        *://www.google.vu/search*
// @match        *://www.google.ws/search*
// @match        *://www.google.rs/search*
// @match        *://www.google.co.za/search*
// @match        *://www.google.co.zm/search*
// @match        *://www.google.co.zw/search*
// @match        *://www.google.cat/search*

// @require      http://code.jquery.com/jquery-1.12.4.min.js
// @require      https://cdn.jsdelivr.net/gh/meetselva/attrchange@2.0.1/js/attrchange.js
// @updateURL    https://cdn.jsdelivr.net/gh/L0laapk3/Youtube-Download-Button/download.user.js
// @downloadURL  https://cdn.jsdelivr.net/gh/L0laapk3/Youtube-Download-Button/download.user.js
// @grant        GM.download
// @grant        GM.xmlHttpRequest
// @run-at       document-start
// @connect      onlinevideoconverter.com
// @connect      flvto.biz
// ==/UserScript==


(function() {
    console.log(typeof GM.xmlHttpRequest);

    var button, subButton;
    var topPos;

    var lasturl = "";

    var lastId;

    var youtube = window.location.hostname.indexOf("google") < 0;
    function check() {
        console.log("check");
        if (youtube) {
            if (location.href == lasturl) return;
            lasturl = location.href;
            if (window.location.pathname.indexOf("watch") >= 0) initYT();
        } else if (document.getElementById("footcnt")) {
            initG();
            for (let i = 100; i < 2000; i += 100)
                setTimeout(() => initG(true), i);
        }
    }

    var checkInt = setInterval(check, 50);
    var node;
    if (!youtube) {
        console.log("google");

    } else {
        console.log("youtube");
    }



    node = document.createElement('style');
    node.innerHTML =
    (youtube ?
        "downloadbutton { transition: margin 0.2s; margin-right: 8px; user-select: none; white-space: nowrap; text-transform: uppercase; background-color: orange;color: white;border: solid 2px orange;border-radius: 2px;cursor: pointer; font-size: 1.4rem; letter-spacing: .007px; height: 33px; line-height: 33px; padding: 0 15px; font-weight: 500; z-index: 1; position: relative; }"
    :
        "@import url('https://fonts.googleapis.com/css?family=Roboto:500');" +
        "downloadbutton { width: fit-content; margin-left: 5px; float: right; font-family: Roboto, Arial, sans-serif; transition: margin 0.2s; margin: auto; user-select: none; white-space: nowrap; text-transform: uppercase; background-color: orange;color: white;border: solid 2px orange;border-radius: 2px;cursor: pointer; font-size: 14px; letter-spacing: .007px; height: 33px; line-height: 33px; padding: 0 15px; font-weight: 500; z-index: 1; position: relative; }" +
        "downloadbutton.miniature { margin: 3px auto 5px; float: none; }"
    ) +
    "downloadtype { margin-left: 4px; color: rgba(255, 255, 255, 0.85); }" +
    "downloadtype > span { font-size: 1.05em; }" +
    "downloadprogress { border-bottom: 2px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; position: absolute ;bottom: -2px; width: 100%; left: -2px; overflow: hidden; padding: 0 4px 0 0; height: 2px; }" +
    "downloadprogressbar { background-color: #4a8df8; height: 2px; width: 0; position: absolute; }" +
    "downloadbutton.idle downloadprogress:before, downloadbutton.idle downloadprogress:after { position: absolute; background: #4a8df8; height: 100%; content: ''; }" +
    "downloadbutton.idle downloadprogress:before { animation: increase 2s infinite; } downloadbutton.idle downloadprogress:after { animation: decrease 2s 0.5s infinite; }" +
    "@keyframes increase { from { left: -5%; width: 5%; } to { left: 130%; width: 100%;} } @keyframes decrease { from { left: -80%; width: 80%; } to { left: 110%; width: 10%;} }";

    document.head.append(node);


    let buttons;
    function initG(keep) {
        let YTThumbList = [].slice.call(document.querySelectorAll('a[href^="https://www.youtube.com"] img')).sort((a, b) => b.height*b.width-a.height*a.width);
        if (!keep) {
            clearInterval(checkInt);
            if (buttons) buttons.forEach(b => b.remove());
            buttons = [];
        } else
            YTThumbList = YTThumbList.filter(thumb => !thumb.closest('a[href^="https://www.youtube.com"]').parentNode.parentNode.querySelector("downloadbutton"));
        for (let thumb of YTThumbList) {
            let url, title;
            //<span>&#9660;</span>
            let button = $('<downloadbutton>Download <span class="downloadtype">MP3</span><downloadprogress><downloadprogressbar></downloadprogressbar></downloadprogress></downloadbutton>');

            if (thumb.parentNode.nodeName == "A") {
                let a = thumb.closest('a[href^="https://www.youtube.com"]');
                let insertTarget = a.parentNode.parentNode.children[1];
                if ([].slice.call(insertTarget.childNodes).some(n => n.tagName == "DOWNLOADBUTTON"))
                    continue;
                let titleEl = a.parentNode.parentNode.querySelector('a[href^="https://www.youtube.com"] h3');
                url = a.href;
                title = titleEl.innerText.replace(/ - youtube$/gi, '');
                button.prependTo(insertTarget);
            } else if (thumb.parentNode.nodeName == "G-IMG") {
                let a = thumb.closest('a[href^="https://www.youtube.com"]');
                console.log(a);
                if ([].slice.call(a.parentNode.childNodes).some(n => n.tagName == "DOWNLOADBUTTON"))
                    continue;
                let titleEl = a.children[1];
                url = a.href;
                title = titleEl.innerText;
                titleEl.children[0].style.webkitLineClamp = 3;
                titleEl.children[0].style.maxHeight = "67px";
                button.addClass("miniature").insertAfter(a);
            }

            button.one("click", () => download(button, url.split("=")[1], title));
            buttons.push(button);
        }
    }


    function initYT() {
        if (lastId && button && lastId == button.closest("ytd-watch, ytd-watch-flexy").attr("video-id")) return;
        console.warn("init!", lastId);
        subButton = topPos = undefined;
        isThere = false;
        if (button) button.remove();
        if (location.href.indexOf("watch") == -1) return;
        clearInterval(checkInt);
        // <span>⯆</span>
        // <span>&#9660;</span>
        button = $('<downloadbutton>Download <span class="downloadtype">MP3</span><downloadprogress><downloadprogressbar></downloadprogressbar></downloadprogress></downloadbutton>');
        button.one("click", () => download(button, button.closest("ytd-watch, ytd-watch-flexy").attr("video-id"), button.closest("[id='primary-inner']").find("[id='info-contents'] .title").text().replace(/[\\\/:*?<>|]|^ | $|\.$|\n\n|\r/g, '')));
        waitForDiv(button);
        var url = window.location.href;
        /*setTimeout(function() {
            if (window.location.href != url) {
                url = window.location.href;
                waitForDiv();
            }
        }, 1000);*/
    }

    var happened = false;
    function waitForDiv(button, i) {
        var div = $('#meta-contents [id="subscribe-button"]')
            .filter(function(e) { return !$("ytd-search").find(e).length; })
            .filter(function(i, e) { return $(e).offset().top - $("body").offset().top; })
            .sort(function(a, b) { return $(b).offset().top - $(a).offset().top; })
            .first();
        var infoContents = div.closest("[id='primary-inner']").find("[id='info-contents'] [id='container']");
        if (div.length && div.find("paper-button").length && infoContents.length) {
            div.before(button);
            subButton = div;
            topPos = {
                marginTop: infoContents.offset().top - subButton.offset().top + (24 - 37)/2 + "px",
                marginRight: subButton.find("paper-button").offset().left - subButton.offset().left - subButton.width() + "px"
            };
            lastId = button.closest("ytd-watch, ytd-watch-flexy").attr("video-id");
            moveButton(0);
            button.closest("ytd-watch, ytd-watch-flexy").attrchange({callback: function() {
                if (happened) return;
                happened = true;
                setTimeout(function() { happened = false; }, 0);
                if ((!button || !button.offset() || !(button.offset().top - $("body").offset().top)) && location.href.indexOf("watch") > -1)
                    initYT();
                else if (lastId && lastId != button.closest("ytd-watch, ytd-watch-flexy").attr("video-id"))
                    initYT();
                else
                    hasScrolled();
            }});
        } else if ((i || 0) < 50)
            setTimeout(function() { waitForDiv(button, i + 1 || 1); }, 50);
    }


    function download(button, id, title) {



        button.addClass("idle")[0].style.cursor = "progress";
        console.assert(id && id.length > 2, "could not extract youtube id");
        var url = "https://www.youtube.com/watch?v=" + id;
        console.assert(title && title.length > 0, "could not extract youtube title");



        var left = [];
        var lowestNonFail = 0;
        var errors = {};
        var finishFn = [];
        var abortFn = [];
        var done = false;
        var highestProgress = [];
        var lastProgress = -1;
        downloaderList.forEach(function(e, i) {
            left.push(e.length);
            finishFn.push([]);
            highestProgress[i] = -1;
            var allProgress = [];
            e.forEach(function(dler, j) {
                var first = true;
                allProgress[j] = -1;
                console.log("request download of ", dler);
                setTimeout(function() {
                    try {
                        dler.downloadFn(url, title, id, function(dlUrl) {

                            console.log("finished ", dler, dlUrl);

                            if (!first) return;

                            function thisFinish() {
                                var fullDownloadProgessBar = undefined;
                                var thisAbort = finish(button, dlUrl, title, function() {
                                    error("invalid download url");
                                }, function(a) {
                                    if (first) {
                                        first = false;
                                        abortFn.splice(abortFn.indexOf(thisAbort), 1);
                                        abortFn.forEach(function(e) { e(); });
                                    }
                                    if (!fullDownloadProgessBar)
                                        fullDownloadProgessBar = (lastProgress > 1) ? 50 : 100;
                                    highestProgress[i] = Math.max(highestProgress[i] || 0, allProgress[j] = 100 - fullDownloadProgessBar + a.done * fullDownloadProgessBar / a.total);
                                    progress(button, allProgress[j], dler.name);
                                });
                                abortFn.push(thisAbort);
                            }

                            if (lowestNonFail == i && !done)
                                thisFinish();
                            else
                                finishFn[i].push(thisFinish);

                        }, error, function(prog) {
                            highestProgress[i] = Math.max(highestProgress[i] || 0, allProgress[j] = prog);
                            if (lowestNonFail == i && !done) {
                                progress(button, lastProgress = highestProgress[i], dler.name);
                            }
                        });
                    } catch (err) {
                        error(err);
                    }


                    function error(err) {

                            if (done)
                                return;
                            console.log("errored ", dler);

                            errors[dler.name] = err;
                            if (--left[i] == 0) {
                                while (!left[lowestNonFail]) {
                                    lowestNonFail++;
                                    if (lowestNonFail >= left.length)
                                        return downloadError(errors);
                                }
                                if (lowestNonFail < left.length) {
                                    if (finishFn[lowestNonFail].length)
                                        finishFn[lowestNonFail][0]();
                                    else
                                        progress(button, lastProgress = highestProgress[lowestNonFail]);
                                }

                            } else if (lowestNonFail == i) {
                                allProgress[j] = -1;
                                progress(button, lastProgress = highestProgress[i] = allProgress.reduce(function(a, b) { return Math.max(a, b); }));
                            }
                        }
                }, 0);

            });

        });
    }






    function downloadError(errors) {
        var string = "download error :(";
        for (const key of Object.keys(errors)) {
            console.warn(key, errors[key]);
            string += "\n" + key + ": " + errors[key];
        }
        alert(string);
        youtube ? initYT() : initG();
    }


    function progress(button, i, name) {
        console.log("progress", i, name, button);
        if (button) {
            if (i == -1)
                button.addClass("idle");
            else
                button.removeClass("idle");
            console.log(window.tmp = button.find("downloadprogressbar"));
            button.find("downloadprogressbar").css({width: i <= 0 ? 0 : i + "%"});
        }
    }




    function finish(button, downloadUrl, title, error, onprogress) {

        console.log("real title:", title);
        console.log("trying url:", downloadUrl);

        var first = true;
        var dlObject = GM.download({
            url: downloadUrl,
            name: title + ".mp3",
            onload: function(a) {
                console.log("success!");
                button[0].style.cursor = "default";
                progress(button, -2);
            },
            onprogress: onprogress,
            onerror: error
        });
        return dlObject.abort;
    }


    if (youtube) {
        $(document).scroll(hasScrolled);

        function hasScrolled() { moveButton(200); }
        var isThere = false;

        function moveButton(delay) {
            if (!subButton || !button || !topPos) return;
            if ($(document).scrollTop() + window.innerHeight <= subButton.find("paper-button").offset().top + button.height() + 1) {
                if (isThere) return;
                button.css(topPos);
                isThere = true;
            } else {
                if (!isThere) return;
                button.css({marginTop: "7px", marginRight: ''});
                isThere = false;
            }
        }
    }

    $.extend($.easing, {
        easeInOut: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
            return -c/2 * ((t-=2)*t*t*t - 2) + b;
        }
    });











    var downloaders = [

        {


            name: "flvto.biz",
            priority: -1,
            downloadFn: function(url, title, id, finish, error, progress) {
                GM.xmlHttpRequest({
                    method: "POST",
                    url: "https://www.flvto.biz/nl/convert/",
                    data: "url=" + encodeURIComponent(url) + "&format=1&service=youtube",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    onload: function(a) {
                        if (a.status != 200)
                            return error(a.status);
                        var match = /"status" *: *"([^"]*)" *, *"statusUrl" *: *"?([^"]*)"?/m.exec(a.responseText);
                        if (!match || !match[1] || !match[2])
                            return error("no status url");

                        if (match[1] == "ready")
                            return finish("http://www.flvto.biz/nl/download/direct/mp3/yt_" + url.split("=")[1] + "/");

                        var statusUrl = "http://www.flvto.biz" + match[2].replace(/\\/g, '');

                        var i = 0, lastProgress = 0;
                        function checkStatus() {
                            GM.xmlHttpRequest({
                                method: "GET",
                                url: statusUrl,
                                onload: function(a) {
                                    if (a.status != 200)
                                        return error("status " + a.status);
                                    try {
                                        var json = JSON.parse(a.responseText);
                                        if (json.status == "redirect") {
                                            statusUrl = "http://www.flvto.biz" + json.status_url;
                                            checkStatus();
                                        } else if (json.status == "error" || json.error) {
                                            return error("status returned error");
                                        } else if (json.status == "finish") {
                                            return finish("http://www.flvto.biz/nl/download/direct/mp3/yt_" + id + "/");
                                        } else {
                                            if (json.progress) {
                                                if (json.progress != lastProgress) {
                                                    lastProgress = json.progress;
                                                    progress((json.status == "convert" ? 50 : 0) + json.progress / 2);
                                                    i = 0;
                                                } else
                                                    i++;
                                            } else
                                                i++;

                                            if (i > (lastProgress == "5.1" ? 30 : 5) * 1000 / 100) return error("progress stuck"); //5 seconds without progress change

                                            return setTimeout(checkStatus, 100);
                                        }

                                    } catch (err) {
                                        return error("json: " + err);
                                    }
                                },
                                onerror: error
                            });
                        }
                        checkStatus();
                    },
                    onerror: error
                });
            }


        }, {


//broken
            name: "onlinevideoconverter.com",
            priority: 1,
            downloadFn: function(url, title, id, finish, error, progress) {
                GM.xmlHttpRequest({
                    method: "POST",
                    url: "https://www3.onlinevideoconverter.com/webservice",
                    data: {
                        function: "validate",
                        args: {
                            urlEntryUser: url,
                            fromConvert: "urlconverter",
                            requestExt: "mp3",
                            videoResolution: -1,
                            audioBitrate: 0,
                            audioFrequency: 0,
                            channel: "stereo",
                            volume: 0,
                            startFrom: -1,
                            endTo: -1,
                            custom_resx: -1,
                            custom_resy: -1,
                            advSettings: false,
                            aspectRatio: -1
                        }
                    },
                    onload: function(a) {
                        if (a.status != 200)
                            return error("status " + a.status);
                        try {
                            var response = JSON.parse(a.responseText);
                            if (response.dPageId && response.dPageId.length > 2)
                                return $.ajax({
                                    url: "https://www.onlinevideoconverter.com/nl/success?id=" + response.dPageId,
                                    success: function(b) {
                                        try {
                                            finish(/\{'url': '([^']+)'/m.exec(b)[1]);
                                        } catch (err) {
                                            error(err);
                                        }
                                    }
                                });
                            else if (response.status == "ok")
                                return finish(response.serverUrl + "/download?file=" + response.id_process);
                            error(JSON.stringify(response));
                        } catch (err) {
                            return error("json: " + err);
                        }
                    }
                });
            }


        }, {


//broken
            name: "convert2mp3.cc",
            priority: 0,
            downloadFn: function download_convert2mp3(url, title, id, finish, error, progress, i) {
                $.ajax({
                    url: "https://api.convert2mp3.net/check.php?v=" + url.split("v=")[1].split("&")[0] + "&h=" + Math.floor(35e5 * Math.random()),
                    success: function(t) {
                        var o = t.split("|");
                        if("OK" == o[0])
                            return finish("http://dl" + o[1] + ".downloader.space/dl.php?id=" + o[2]);
                        if(i > ((o[1] == "PENDING" || o[0] == "DOWNLOAD") ? 100 : 3))
                            return error("timeout");
                        setTimeout(function() {
                            download_convert2mp3(url, title, id, finish, error, progress, i + 1 || 1);
                        }, 5e3);
                    },
                    error: function(e) { error(JSON.stringify(e)); }
                });
            }



        }
    ];

    var downloaderList = [];
    for (const key of Object.keys(downloaders))
        if (downloaderList.indexOf(downloaders[key].priority) == -1)
            downloaderList.push(downloaders[key].priority);
    downloaderList.sort(function(a, b) { return b - a; });
    downloaderList.forEach(function(e, i) {
        downloaderList[i] = [];
        for (const key of Object.keys(downloaders))
            if (downloaders[key].priority == e)
                downloaderList[i].push(downloaders[key]);
    });
    console.log(downloaderList);


})();